---
const {
  src,
  alt = "Cocktail Catering Moving Bars",
  height = "clamp(180px, 32vh, 340px)",
} = Astro.props;
---

<section class="parallax-banner full-bleed" style={`--banner-h:${height};`}>
  <img class="parallax-img" src={src} alt={alt} loading="eager" decoding="async" fetchpriority="high" />
</section>

<script is:inline>
  (() => {
    const reduce = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;
    if (reduce) return;

    const banners = document.querySelectorAll(".parallax-banner");
    if (!banners.length) return;

    let ticking = false;

    const update = () => {
      ticking = false;
      const vh = window.innerHeight || 1;

      banners.forEach((el) => {
        const img = el.querySelector(".parallax-img");
        if (!img) return;

        const r = el.getBoundingClientRect();
        if (r.bottom < 0 || r.top > vh) return;

        const progress = (r.top + r.height / 2 - vh / 2) / vh;
        const y = Math.max(-28, Math.min(28, progress * -24));
        img.style.transform = `translate3d(0, ${y}px, 0) scale(1.06)`;
      });
    };

    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(update);
    };

    update();
    window.addEventListener("scroll", onScroll, { passive: true });
    window.addEventListener("resize", () => {
      update();
    });
  })();
</script>

<style>
  .full-bleed {
    width: 100vw;
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
  }

  .parallax-banner {
    position: relative;
    height: var(--banner-h);
    overflow: hidden;
    background: #000;
  }

  .parallax-img {
    position: absolute;
    inset: -10%;
    width: 120%;
    height: 120%;
    object-fit: cover;
    object-position: center;
    will-change: transform;
    transform: translate3d(0, 0, 0) scale(1.06);
    transition: transform 200ms ease;
  }

  @media (prefers-reduced-motion: reduce) {
    .parallax-img {
      transform: none !important;
      transition: none;
    }
  }
</style>
