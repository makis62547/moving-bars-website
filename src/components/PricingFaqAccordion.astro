---
import { pricing } from "../data/pricing/pricing";
import { i18n, type Lang } from "../i18n";

const { t: passedT, lang: passedLang } = Astro.props as { t?: (typeof i18n)["de"]; lang?: Lang };
const pathLang = Astro.url?.pathname?.split("/")[1];
const lang = (passedLang ?? (pathLang === "en" ? "en" : pathLang === "de" ? "de" : undefined) ?? "de") as Lang;
const t = passedT ?? i18n[lang] ?? i18n.de;
const faq = t?.faqMobileCocktailbar;
const formatMoney = (value: number | null) => {
  if (value === null) return t.pricing.value.onRequest;

  return new Intl.NumberFormat(lang === "en" ? "en-US" : "de-DE", {
    style: "currency",
    currency: pricing.currency,
    minimumFractionDigits: 2,
  }).format(value / 100);
};

const faqItems = faq
  ? [
      { question: faq.q1, answer: faq.a1 },
      { question: faq.q2, answer: faq.a2 },
      { question: faq.q3, answer: faq.a3 },
      { question: faq.q4, answer: faq.a4 },
      { question: faq.q5, answer: faq.a5 },
      { question: faq.q6, answer: faq.a6 },
      { question: faq.q7, answer: faq.a7 },
      { question: faq.q8, answer: faq.a8 },
      { question: faq.q9, answer: faq.a9 },
      { question: faq.q10, answer: faq.a10 },
    ]
  : [];

const translateKey = (key?: string) => key?.split(".").reduce((acc: Record<string, any> | undefined, part) => acc?.[part], t);
const allPackagesLabel = t?.cta?.allPackagesAndPrices ?? "Hier alle Pakete und Preise";
const faqButtonLabel = t?.cta?.faqMobileCocktailbar ?? faq?.buttonLabel ?? "FAQ";
---

<div class="h1-accordion">
  <details class="h1-acc-item">
    <summary class="panel-cta mb-btn">{allPackagesLabel}</summary>
    <div class="h1-acc-fullbleed">
      <div class="h1-acc-fullbleed-inner">
        <div class="accordion-content">
          <div class="table-wrapper">
            <table class="pricing-table">
              <thead>
                <tr>
                  <th scope="col">{t.pricing.table.package}</th>
                  <th scope="col">{t.pricing.table.recommendedFor}</th>
                  <th scope="col">{t.pricing.table.drinksIncluded}</th>
                  <th scope="col">{t.pricing.table.bartenders}</th>
                  <th scope="col">{t.pricing.table.barSetup}</th>
                  <th scope="col">{t.pricing.table.price}</th>
                  <th scope="col">{t.pricing.table.withBackbar}</th>
                </tr>
              </thead>
              <tbody>
                {pricing.packages.map((pkg) => {
                  const packageName = translateKey(pkg.nameKey) ?? pkg.nameKey;
                  const recommendedFor = translateKey(pkg.recommendedForKey) ?? pkg.recommendedForRaw;
                  const drinksIncluded = translateKey(pkg.drinksIncludedKey) ?? pkg.drinksIncludedRaw;
                  const bartenders = translateKey(pkg.bartendersKey) ?? pkg.bartendersRaw;
                  const barSetup = translateKey(pkg.barSetupKey) ?? pkg.barSetupRaw;

                  return (
                    <tr id={pkg.id}>
                      <th scope="row" class="package-name">{packageName}</th>
                      <td>{recommendedFor}</td>
                      <td>{drinksIncluded}</td>
                      <td>{bartenders}</td>
                      <td>{barSetup}</td>
                      <td
                        data-price-no-backbar-cents={pkg.priceNoBackbarCents ?? undefined}
                        data-currency={pricing.currency}
                      >
                        {formatMoney(pkg.priceNoBackbarCents)}
                      </td>
                      <td
                        data-price-with-backbar-cents={pkg.priceWithBackbarCents ?? undefined}
                        data-currency={pricing.currency}
                      >
                        {formatMoney(pkg.priceWithBackbarCents)}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div class="pricing-notes">
            <p class="note-kicker">{t.pricing.notes.title}</p>
            <p class="note-text">{t.pricing.notes.vat}</p>
            <p class="note-text">
              {t.pricing.notes.extraDrink.replace("{price}", formatMoney(pricing.notes.extraDrinkNetCents))}
            </p>
            <p class="note-text">
              {t.pricing.notes.glassLoss.replace("{price}", formatMoney(pricing.notes.glassLossNetCents))}
            </p>
            <p class="note-text">{t.pricing.notes.travel.replace("{km}", String(pricing.notes.freeKm))}</p>
          </div>
        </div>
      </div>
    </div>
  </details>

  <details class="h1-acc-item">
    <summary class="panel-cta mb-btn">{faqButtonLabel}</summary>
    <div class="h1-acc-fullbleed">
      <div class="h1-acc-fullbleed-inner">
        <div class="accordion-content">
          <div class="faq-block">
            {faqItems.map((item) => (
              <div class="faq-item">
                <h3 class="faq-q">{item.question}</h3>
                <p class="faq-a">{item.answer}</p>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </details>
</div>

<style>
  .h1-accordion {
    width: min(100%, var(--h1-accordion-width, var(--tile-text-width)));
    margin-left: auto;
    margin-right: auto;
    display: flex;
    flex-direction: column;
    gap: var(--h1-accordion-gap);
    padding-top: var(--h1-accordion-pad-top);
  }

  .h1-acc-item {
    border: 0;
    padding: 0;
    background: none;
    overflow: visible;
  }

  .h1-acc-item summary {
    list-style: none;
    cursor: pointer;
    box-sizing: border-box;
  }

  .h1-acc-item summary.mb-btn {
    width: auto !important;
    max-width: var(--h1-accordion-width, var(--tile-text-width));
    margin-left: auto;
    margin-right: auto;
  }

  .h1-acc-item summary::-webkit-details-marker {
    display: none;
  }

  details[open] {
    margin-bottom: var(--h1-accordion-open-gap-bottom);
  }

  .h1-acc-fullbleed {
    width: 100vw;
    max-width: none;
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
    padding-inline: var(--h1-accordion-fullbleed-pad-inline, var(--section-pad-inline));
    margin-top: var(--h1-accordion-fullbleed-gap-top);
    box-sizing: border-box;
  }

  .h1-acc-fullbleed-inner {
    width: 100%;
    max-width: var(--h1-accordion-fullbleed-max-width, var(--content-max, 1240px));
    margin: 0 auto;
    box-sizing: border-box;
  }

  .accordion-content {
    display: grid;
    gap: var(--h1-accordion-gap);
    padding-top: var(--h1-accordion-pad-top);
    padding-inline: var(--section-pad-inline);
    box-sizing: border-box;
    width: 100%;
    max-width: none;
    margin: 0;
  }

  .table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .pricing-table {
    width: 100%;
    min-width: 720px;
    border-collapse: collapse;
    color: var(--text-color);
  }

  .pricing-table th,
  .pricing-table td {
    text-align: left;
    padding: 0.8rem 0.65rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    vertical-align: top;
    font-family: var(--body-font-family);
  }

  .pricing-table thead th {
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    color: var(--accent);
  }

  .pricing-table tbody th {
    font-weight: 700;
    width: 22%;
    color: var(--accent);
  }

  .pricing-table tbody td {
    color: rgba(255, 255, 255, 0.86);
  }

  .pricing-notes {
    display: grid;
    gap: 0.4rem;
    padding: clamp(0.85rem, 1.4vw, 1rem);
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.03);
  }

  .note-kicker {
    margin: 0;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .note-text {
    margin: 0;
    color: rgba(255, 255, 255, 0.88);
    line-height: 1.6;
  }

  .faq-block {
    max-width: var(--h1-faq-max-width);
    margin: 0 auto;
  }

  @media (min-width: 900px) {
    .faq-block {
      max-width: none;
      width: 100%;
      margin: 0;
    }
  }

  .faq-item + .faq-item {
    margin-top: var(--h1-faq-item-gap);
  }

  .faq-q {
    margin: 0 0 0.35rem 0;
    color: var(--accent);
    text-transform: uppercase;
    font-size: clamp(1.05rem, 1.25vw, 1.25rem);
  }

  .faq-a {
    margin: 0 0 1rem 0;
    color: #fff;
    line-height: 1.7;
  }
</style>
