---
import { i18n, type Lang } from "../i18n";

const pathLang = Astro.url?.pathname?.split("/")[1];
const lang = (pathLang === "en" ? "en" : "de") as Lang;
const t = i18n[lang] ?? i18n.de;

const cocktailImage = "/images/moving-bars-cocktail-geschichten.jpg";
const movingBarsImage = "/images/20-jahre-mobile-cocktailbar.jpg";

const selectPosts = (posts, count = 4) => {
  const featuredPosts = posts.filter(({ featured }) => featured);
  const regularPosts = posts.filter(({ featured }) => !featured);

  return [...featuredPosts, ...regularPosts].slice(0, count);
};

const cocktailPosts = [
  {
    title: "SIGNATURE DRINKS",
    date: "12. August 2024",
    excerpt:
      "Wie unsere Barkeeper neue Lieblingsdrinks entwickeln – von der ersten Idee bis zur perfekt ausbalancierten Komposition im Glas.",
    featured: true,
    image: cocktailImage,
    alt: "Placeholder für Cocktail Story",
  },
  {
    title: "BACKSTAGE",
    date: "02. August 2024",
    excerpt:
      "Ein Blick hinter die Kulissen unserer mobilen Bars: Logistik, Setup und die kleinen Details, die Events unvergesslich machen.",
    featured: false,
    image: cocktailImage,
    alt: "Placeholder für Cocktail Story",
  },
  {
    title: "BAR TEAM",
    date: "21. Juli 2024",
    excerpt:
      "Lerne das Team kennen: Persönliche Geschichten, Lieblingsdrinks und was unsere Crew bei langen Nächten antreibt.",
    featured: true,
    image: cocktailImage,
    alt: "Placeholder für Cocktail Story",
  },
  {
    title: "EVENT HIGHLIGHTS",
    date: "10. Juli 2024",
    excerpt:
      "Die schönsten Momente der letzten Monate – vom Messeauftritt bis zur Rooftop-Party über den Dächern der Stadt.",
    featured: false,
    image: cocktailImage,
    alt: "Placeholder für Cocktail Story",
  },
];

const movingBarsPosts = [
  {
    title: "EVENT HIGHLIGHTS",
    date: "05. August 2024",
    excerpt:
      "Unsere schönsten mobilen Cocktailbar-Momente der letzten Jahre – von Rooftop-Sommernächten bis zu eleganten Galas.",
    featured: true,
    image: movingBarsImage,
    alt: "Highlight der mobilen Cocktailbar",
  },
  {
    title: "SO ARBEITEN WIR",
    date: "28. Juli 2024",
    excerpt:
      "Ein Blick in unseren Ablauf: Beratung, Planung und Bar-Setup, damit jede Veranstaltung reibungslos läuft.",
    featured: true,
    image: movingBarsImage,
    alt: "Arbeitsweise der mobilen Cocktailbar",
  },
  {
    title: "TIPPS FÜR DEIN EVENT",
    date: "18. Juli 2024",
    excerpt:
      "Worauf du bei der Planung einer mobilen Cocktailbar achten solltest – vom passenden Menü bis zur perfekten Gästezahl.",
    featured: false,
    image: movingBarsImage,
    alt: "Planungstipps für Events",
  },
];
---

<section class="blogs-overview" aria-label="Blogübersicht">
  <section class="blog-block">
    <div class="blog-intro">
      <div class="blog-intro-text">
        <h2 class="blog-title">
          <span class="accent-text">{t.blog.cocktailStories.title.accent} </span>
          {t.blog.cocktailStories.title.rest}
        </h2>
        <div class="blog-divider" aria-hidden="true"></div>
        <div class="blog-intro-copy">
          <p>{t.blog.cocktailStories.intro.p1}</p>
          <p>{t.blog.cocktailStories.intro.p2}</p>
          <p>{t.blog.cocktailStories.intro.p3}</p>
          <details class="blog-intro-details">
            <summary>{t.blog.cocktailStories.more.label}</summary>
            <p>{t.blog.cocktailStories.more.p1}</p>
            <p>{t.blog.cocktailStories.more.signoff}</p>
          </details>
        </div>
      </div>

      <div class="blog-intro-media is-blog-cocktail" aria-label="Cocktail Blog Bild" data-panel-parallax data-speed="0.35">
        <div class="blog-intro-bg panel-bg" role="presentation" style={`background-image:url('${cocktailImage}')`}></div>
      </div>
    </div>

    <div class="blog-posts" aria-label="Neueste Cocktail Stories">
      <div class="blog-posts-inner">
        <div class="posts-grid">
          {selectPosts(cocktailPosts, 3).map((post) => (
            <article class="post-card">
              <div class="post-media">
                <img src={post.image} alt={post.alt} loading="lazy" />
              </div>
              <div class="post-body">
                <h3 class="post-title">{post.title}</h3>
                <p class="post-meta">{post.date}</p>
                <p class="post-excerpt">{post.excerpt}</p>
                <a class="post-cta" href="#">{t.blog.readMoreCta}</a>
              </div>
            </article>
          ))}
        </div>

        <div class="blog-overview-link">
          <a class="blog-cta" href="/blog/cocktail-geschichten">Alle Artikel aus den Cocktail Geschichten</a>
        </div>
      </div>
    </div>
  </section>

  <section class="blog-block">
    <div class="blog-intro blog-intro--reverse">
      <div class="blog-intro-text">
        <h2 class="blog-title">
          <span class="accent-text">{t.blog.movingBars20Years.title.accent} </span>
          {t.blog.movingBars20Years.title.rest}
        </h2>
        <div class="blog-divider" aria-hidden="true"></div>
        <div class="blog-intro-copy">
          <p>{t.blog.movingBars20Years.intro.p1}</p>
          <p>{t.blog.movingBars20Years.signoff}</p>
        </div>
      </div>

      <div class="blog-intro-media is-blog-coffee" aria-label="Kaffee Blog Bild" data-panel-parallax data-speed="0.35">
        <div class="blog-intro-bg panel-bg" role="presentation" style={`background-image:url('${movingBarsImage}')`}></div>
      </div>
    </div>

    <div class="blog-posts" aria-label="Neueste Kaffee Momente">
      <div class="blog-posts-inner">
        <div class="posts-grid">
          {selectPosts(movingBarsPosts).map((post) => (
            <article class="post-card">
              <div class="post-media">
                <img src={post.image} alt={post.alt} loading="lazy" />
              </div>
              <div class="post-body">
                <h3 class="post-title">{post.title}</h3>
                <p class="post-meta">{post.date}</p>
                <p class="post-excerpt">{post.excerpt}</p>
                <a class="post-cta" href="#">{t.blog.readMoreCta}</a>
              </div>
            </article>
          ))}
        </div>

        <div class="blog-overview-link">
          <a class="blog-cta" href="/blog/20-jahre-moving-bars">Alle Artikel aus 20 Jahren moving bars</a>
        </div>
      </div>
    </div>
  </section>
</section>

<style>
  .blogs-overview {
    width: 100vw;
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
    padding: var(--blogs-pad-block) var(--blogs-pad-inline);
    background: #000;
    color: var(--text-color);
    display: grid;
    gap: var(--blogs-pad-block);
    border-radius: 0 !important;
  }

  .blog-block {
    display: grid;
    gap: var(--blogs-gap);
    border-radius: 0 !important;
  }

  .blog-intro {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--blogs-intro-gap, 0);
    min-height: var(--blogs-intro-min-height);
    align-items: stretch;
    border-radius: 0 !important;
  }

  .blog-intro-text {
    padding: var(--blogs-intro-text-pad);
    background: var(--blogs-intro-text-bg, #000);
    display: grid;
    align-content: center;
    gap: var(--blogs-gap);
    border-radius: 0 !important;
  }

  .blog-title {
    margin: 0;
    font-size: clamp(2.2rem, 4vw, 3rem);
    line-height: var(--heading-line-height);
    text-transform: uppercase;
    color: var(--heading-color);
  }

  .blog-divider {
    width: var(--blogs-divider-width);
    height: var(--blogs-divider-height);
    margin-top: var(--blogs-divider-gap);
    background: var(--accent);
  }

  .blog-intro-copy {
    margin: 0;
    max-width: 70ch;
    color: rgba(247, 247, 247, 0.82);
    line-height: 1.7;
  }

  .blog-intro-copy p {
    margin: 0;
  }

  .blog-intro-details {
    margin: 0;
  }

  .blog-intro-details summary {
    cursor: pointer;
    color: var(--accent);
    list-style: none;
  }

  .blog-intro-details summary::-webkit-details-marker {
    display: none;
  }

  .blog-intro-media {
    position: relative;
    overflow: hidden;
    min-height: var(--blogs-intro-min-height);
    height: 100%;
    padding-inline: var(--blogs-intro-media-pad-inline, 0);
    border-radius: 0 !important;
  }

  .blog-intro-media.is-blog-cocktail {
    --bg-zoom: 15%;
    --bg-x: 50%;
    --bg-y: 50%;
  }

  .blog-intro-media.is-blog-coffee {
    --bg-zoom: 40%;
    --bg-x: 50%;
    --bg-y: 50%;
  }

  .blog-intro-media.is-blog-cocktail .panel-bg,
  .blog-intro-media.is-blog-coffee .panel-bg {
    background-size: auto calc(100% + var(--bg-zoom, 0%));
    background-position: var(--bg-x, 50%) calc(var(--bg-y, 50%) + var(--py, 0px));
  }

  .blog-intro-media .panel-bg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    background-size: contain;
    background-position: center calc(50% + var(--py, 0px));
    background-repeat: no-repeat;
    background-color: #000;
    background-attachment: scroll;
    z-index: 0;
    border-radius: 0 !important;
  }

  .blog-posts {
    width: 100%;
    margin: 0 auto;
    margin-top: var(--blogs-posts-top-gap, 0);
    padding-inline: 0;
    padding-bottom: var(--blogs-posts-bottom-gap);
    border-radius: 0 !important;
  }

  .blog-posts-inner {
    width: 100%;
    max-width: var(--blogs-posts-max-width, var(--services-max-width));
    margin-inline: auto;
    padding-inline: var(--section-pad-inline);
    display: grid;
    gap: var(--blogs-gap);
    justify-content: start;
  }

  .posts-grid {
    display: grid;
    width: 100%;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: var(--blogs-post-grid-gap, var(--blogs-gap));
    justify-items: stretch;
    grid-auto-rows: 1fr;
  }

  .blog-cta {
    display: inline-block;
    margin-top: var(--blogs-cta-margin-top);
    padding-inline: var(--blogs-cta-inline-pad);
    font-size: var(--blogs-cta-font-size);
    color: rgba(247, 247, 247, 0.9);
    text-decoration: underline;
    text-underline-offset: 0.2em;
  }

  .blog-cta:focus-visible {
    outline: 1px solid rgba(var(--accent-rgb), 0.55);
    outline-offset: 2px;
  }

  .blog-overview-link {
    margin-top: var(--blogs-overview-link-gap);
    text-align: right;
  }

  .post-card {
    background: var(--blogs-post-card-bg, var(--services-card-bg));
    border: none !important;
    box-shadow: var(--blogs-post-card-glow, var(--services-card-glow));
    padding: var(--blogs-post-card-pad, clamp(1rem, 2vw, 1.4rem));
    display: grid;
    gap: 0;
    min-height: var(--blogs-post-card-height);
    height: 100%;
    border-radius: 0 !important;
  }

  .post-media {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    border-radius: 0 !important;
    border: none !important;
    background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.25), rgba(var(--accent-rgb), 0.08));
  }

  .post-media img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    border-radius: 0;
  }

  .post-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: clamp(0.45rem, 1vw, 0.85rem);
    align-content: start;
    min-height: 0;
    height: 100%;
    padding-top: clamp(0.9rem, 1.3vw, 1.2rem);
    border-radius: 0 !important;
  }

  .post-title {
    margin: 0;
    font-size: clamp(1.05rem, 1.6vw, 1.2rem);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--accent);
  }

  .post-meta {
    margin: 0;
    color: rgba(247, 247, 247, 0.7);
    letter-spacing: 0.02em;
    font-size: 0.95rem;
  }

  .post-excerpt {
    margin: 0;
    color: rgba(247, 247, 247, 0.82);
    line-height: 1.5;
  }

  .post-cta {
    margin-top: auto;
    align-self: start;
    display: inline-block;
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: 0.2em;
    letter-spacing: 0.08em;
    padding: 0;
    border-radius: 0 !important;
    transition: color 160ms ease;
  }

  .post-cta:hover,
  .post-cta:focus-visible {
    color: #fff;
    text-decoration: underline;
  }

  @media (max-width: 900px) {
    .blog-intro {
      display: grid;
      grid-template-columns: 1fr;
    }

    .blog-intro > .blog-intro-media { order: 0; }
    .blog-intro > .blog-intro-text { order: 1; }
  }

  @media (min-width: 900px) {
    .blog-intro {
      grid-template-columns: 1fr 1fr;
      grid-auto-flow: dense;
      align-items: stretch;
    }

    .blog-intro-text { align-self: stretch; }

    .blog-intro--reverse .blog-intro-text { order: 2; }
    .blog-intro--reverse .blog-intro-media { order: 1; }

    .posts-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .post-body {
      gap: clamp(0.55rem, 0.8vw, 0.85rem);
    }
  }

  @media (min-width: 1200px) {
    .posts-grid {
      grid-template-columns: repeat(var(--blogs-posts-cols-desktop), minmax(0, 1fr));
    }
  }

  /* Sicherheitsnetz gegen Rundungen */
  .blog-intro,
  .blog-intro-media,
  .blog-intro-text,
  .blog-media-bg,
  .post-card,
  .post-media,
  .post-body,
  .post-cta,
  .post-card *,
  .blog-posts,
  .blogs-overview,
  .blog-block {
    border-radius: 0 !important;
  }
</style>

<script>
  const panels = Array.from(document.querySelectorAll("[data-panel-parallax]"));

  const updateParallax = () => {
    const viewportCenter = window.innerHeight / 2;

    panels.forEach((panel) => {
      const rect = panel.getBoundingClientRect();
      const distanceFromCenter = rect.top + rect.height / 2 - viewportCenter;
      const speed = Number(panel.dataset.speed ?? "0.3");

      panel.style.setProperty("--py", `${-distanceFromCenter * speed}px`);
    });
  };

  const scheduleUpdate = () => {
    requestAnimationFrame(updateParallax);
  };

  updateParallax();
  window.addEventListener("scroll", scheduleUpdate, { passive: true });
  window.addEventListener("resize", scheduleUpdate);
</script>
