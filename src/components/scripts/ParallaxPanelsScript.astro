<script is:inline>
  (() => {
    if (typeof window === "undefined") return;

    if (window.__mbParallaxPanelsInit) return;

    window.__mbParallaxPanelsInit = true;

    const prefersReducedMotionQuery =
      typeof window.matchMedia === "function"
        ? window.matchMedia("(prefers-reduced-motion: reduce)")
        : null;

    const getPanels = () =>
      Array.from(document.querySelectorAll("[data-panel-parallax]")).filter(
        (panel) => panel instanceof HTMLElement,
      );

    let panels = getPanels();
    let ticking = false;
    let listenersAttached = false;

    const updateParallax = () => {
      if (prefersReducedMotionQuery?.matches) {
        ticking = false;
        return;
      }

      const viewportCenter = window.innerHeight / 2;

      panels.forEach((panel) => {
        const rect = panel.getBoundingClientRect();
        const distanceFromCenter = rect.top + rect.height / 2 - viewportCenter;
        const speed = parseFloat(panel.getAttribute("data-speed") || "") || 0.35;
        const py = -distanceFromCenter * speed;

        panel.style.setProperty("--py", `${py}px`);

        const panelBg = panel.querySelector(".panel-bg");
        if (panelBg instanceof HTMLElement) {
          panelBg.style.setProperty("--py", `${py}px`);
        }
      });

      ticking = false;
    };

    const scheduleUpdate = () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(updateParallax);
    };

    const initParallax = () => {
      panels = getPanels();

      updateParallax();

      if (!listenersAttached) {
        window.addEventListener("scroll", scheduleUpdate, { passive: true });
        window.addEventListener("resize", scheduleUpdate);
        listenersAttached = true;
      }
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initParallax, { once: true });
    } else {
      initParallax();
    }

    window.addEventListener("astro:page-load", initParallax);
    prefersReducedMotionQuery?.addEventListener("change", updateParallax);
  })();
</script>
